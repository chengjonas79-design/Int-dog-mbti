<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>èŒå® è”èŒ Â· æ¯›å­©å­MBTIæ€§æ ¼æµ‹è¯•</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#666;
      --pri:#2b6aff; --pri2:#eef2ff; --shadow:0 10px 26px rgba(0,0,0,.08);
      --xhs-red: #ff2442;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial;color:var(--text);background:var(--bg); overflow-x: hidden;}
    .wrap{max-width:780px;margin:0 auto;padding:18px 16px 60px;}
    .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:var(--shadow);margin:12px 0;}
    .title{font-size:24px;font-weight:900;margin:0 0 8px;letter-spacing:.2px; line-height: 1.3;}
    .sub{margin:0;color:var(--muted);line-height:1.6; font-size: 15px;}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
    .tag{font-size:12px;color:var(--muted); background: #eee; padding: 2px 8px; border-radius: 4px;}
    .hr{height:1px;background:#eee;margin:16px 0;}
    .q{font-size:19px;font-weight:900;margin:0 0 16px; line-height: 1.4;}
    .opt{width:100%;text-align:left;border:2px solid transparent;border-radius:14px;padding:16px;margin:10px 0;font-size:16px;font-weight:700;cursor:pointer;background:#f7f8ff; transition: all 0.2s;}
    .opt:active{background: var(--pri2); border-color: var(--pri); transform: scale(0.98);}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:15px;}
    button{border:0;border-radius:12px;padding:12px 18px;font-size:16px;font-weight:800;cursor:pointer; transition: opacity 0.2s;}
    button:active{opacity: 0.8;}
    .primary{background:var(--pri);color:#fff; flex: 1; min-width: 120px;}
    .ghost{background:var(--pri2);color:var(--pri); flex: 1; min-width: 120px;}
    .small{padding:10px 12px;border-radius:10px;font-size:14px;font-weight:800; flex: initial;}
    .muted{color:var(--muted);font-size:13px;line-height:1.7;}
    
    #panel { display: none; }
    
    .resultType{font-size:38px;font-weight:1000;letter-spacing:1px;margin:0; color: var(--pri);}

    .resultName{font-size:22px;font-weight:1000;margin:4px 0 6px;}
    .oneLine{font-size:15px;color:#444;line-height:1.7;margin:0; font-style: italic;}
    ul{padding-left:18px;margin:12px 0 0;}
    li{margin:6px 0;}
    .toast{position:fixed;left:50%;top:50%;transform:translate(-50%, -50%);background:rgba(0,0,0,.8);color:#fff;padding:12px 24px;border-radius:12px;font-size:15px;display:none;z-index:999; text-align: center; width: 80%; max-width: 300px;}
    .progressBar{height:6px;background:#eef0ff;border-radius:999px;overflow:hidden;margin-top:15px;}
    .progressBar>div{height:100%;background:var(--pri);width:0%; transition: width 0.3s;}
    
    /* ç”Ÿæˆæµ·æŠ¥æ ·å¼ï¼šç¤¾äº¤è£‚å˜å¡ç‰‡ */
    .poster {
      width: 450px; height: 800px;
      background: linear-gradient(180deg, #EFF4FF 0%, #FFFFFF 40%, #FFFFFF 70%, #F5F8FF 100%);
      border-radius: 26px;
      border: 1px solid rgba(148, 182, 255, 0.34);
      padding: 0;
      display: flex; flex-direction: column; align-items: center;
      color: #111827;
      box-shadow: 0 18px 44px rgba(38, 84, 155, 0.12);
      position: absolute; left: -9999px; top: 0;
      overflow: hidden;
    }

    .poster-top-bar {
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, #3B82F6, #6366F1, #8B5CF6);
      flex-shrink: 0;
    }

    .poster-body {
      flex: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 22px 34px 28px;
    }

    .poster-brand {
      align-self: center;
      font-size: 12px;
      color: #94A3B8;
      letter-spacing: 2px;
      margin-bottom: 18px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .poster .avatar-wrap { margin: 0 0 16px; }
    .poster .avatar-circle {
      width: 140px;
      height: 140px;
      border: 4px solid rgba(59, 130, 246, 0.35);
      box-shadow: 0 8px 32px rgba(37,99,235,0.25);
      overflow: hidden;
      cursor: default;
    }
    .poster .avatar-circle:hover {
      transform: none;
      border-color: rgba(59, 130, 246, 0.35);
      box-shadow: 0 8px 32px rgba(37,99,235,0.25);
    }
    .poster .avatar-circle::after {
      display: none;
    }
    .poster .avatar-circle img {
      object-fit: cover;
    }

    .poster-header { text-align: center; width: 100%; margin-bottom: 10px; }
    .poster-title-main { font-size: 34px; font-weight: 800; color: #111827; line-height: 1.25; letter-spacing: 0.2px; max-width: 370px; margin: 0 auto; }

    .poster-center { text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center; padding-bottom: 0; }
    .poster-type-badge {
      font-size: 82px;
      font-weight: 900;
      letter-spacing: 3px;
      color: #1D4ED8;
      margin: 0 0 6px;
      line-height: 1;
      text-shadow: 0 4px 16px rgba(29,78,216,.22);
    }
    .poster-name-sub { font-size: 28px; font-weight: 800; color: #111827; margin: 0 0 16px; line-height: 1.2; }
    .poster-gold-phrase {
      font-size: 17px;
      color: #475569;
      line-height: 1.7;
      margin-bottom: 18px;
      max-width: 340px;
      margin-left: auto;
      margin-right: auto;
      font-style: italic;
      position: relative;
      padding: 0 8px;
    }

    .poster-pill-group { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 0; margin-bottom: 0; }
    .poster-pill-item {
      min-height: 32px;
      padding: 0 14px;
      border-radius: 999px;
      background: linear-gradient(180deg, #EEF2FF 0%, #E0E7FF 100%);
      color: #3730A3;
      border: 1px solid #C7D2FE;
      font-size: 14px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
    }

    /* åº•éƒ¨åŒºåŸŸï¼šåˆ†å‰²çº¿ + å±…ä¸­äºŒç»´ç  */
    .poster-footer {
      width: 100%;
      margin-top: auto;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
    }

    .poster-footer-divider {
      width: 60%;
      height: 1px;
      background: linear-gradient(90deg, rgba(203,213,225,0), #CBD5E1, rgba(203,213,225,0));
      margin-bottom: 18px;
    }

    .poster-footer-content {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .poster-footer-qr {
      width: 90px;
      height: 90px;
      border-radius: 12px;
      overflow: hidden;
      background: white;
      border: 1px solid #E2E8F0;
      padding: 4px;
      flex-shrink: 0;
    }
    .poster-footer-qr img {
      width: 100%;
      height: 100%;
      display: block;
      border-radius: 8px;
    }

    .poster-footer-text {
      text-align: left;
    }
    .poster-footer-cta {
      font-size: 18px;
      font-weight: 800;
      color: #0F172A;
      margin-bottom: 4px;
      line-height: 1.3;
    }
    .poster-footer-sub {
      font-size: 13px;
      color: #64748B;
      line-height: 1.5;
    }
    
    .footer-left { flex: 1; }
    .test-cta-title { font-size: 16px; font-weight: 800; color: #111827; margin-bottom: 4px; }
    .test-cta-sub { font-size: 13px; color: #6B7280; }
    
    .qr-box { text-align: center; }
    .qr-container { width: 90px; height: 90px; padding: 5px; border: 1px solid #E5E7EB; border-radius: 12px; background: #fff; margin-bottom: 4px; }
    .qr-label { font-size: 11px; color: #9CA3AF; }

    /* ä¼å¾®å¼¹çª—ï¼šä¸ç»“æœé¡µç»Ÿä¸€è§†è§‰ */
    .modal-mask {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(12, 24, 48, 0.42);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal {
      background:
        radial-gradient(circle at 50% -12%, rgba(59,130,246,.16) 0%, rgba(59,130,246,0) 58%),
        linear-gradient(180deg, #FFFFFF 0%, #F8FAFF 100%);
      border-radius: 24px;
      border: 1px solid rgba(148, 182, 255, 0.36);
      box-shadow: 0 20px 44px rgba(15, 23, 42, 0.26);
      padding: 22px 20px 18px;
      width: 100%;
      max-width: 358px;
      position: relative;
      text-align: center;
    }
    .modal-close {
      position: absolute;
      right: 12px;
      top: 12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid #D8E4FF;
      background: #fff;
      color: #8A94A7;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      line-height: 1;
      user-select: none;
    }
    .modal-close:active {
      background: #EEF3FF;
      transform: scale(0.97);
    }
    .modal-title {
      font-size: 28px;
      font-weight: 900;
      line-height: 1.25;
      margin-bottom: 8px;
      color: #0F172A;
      letter-spacing: 0.2px;
    }
    .modal-sub {
      font-size: 15px;
      color: #4B5563;
      line-height: 1.7;
      margin-bottom: 10px;
    }
    .wecom-type-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 30px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid #D4E1FF;
      background: linear-gradient(180deg, #F3F7FF 0%, #EAF1FF 100%);
      color: #1E40AF;
      font-size: 13px;
      font-weight: 800;
      margin-bottom: 12px;
    }
    .wecom-type-chip b {
      margin-left: 4px;
      color: #1D4ED8;
      font-weight: 900;
    }
    .wecom-steps {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 0 0 12px;
    }
    .wecom-step {
      background: rgba(255,255,255,0.8);
      border: 1px solid #E3EBFF;
      border-radius: 10px;
      padding: 7px 8px;
      font-size: 12px;
      color: #475569;
      line-height: 1.5;
      font-weight: 700;
    }
    .wecom-qr-box {
      background: linear-gradient(180deg, #F8FAFF 0%, #F1F6FF 100%);
      border-radius: 14px;
      padding: 12px;
      margin: 0 0 12px;
      border: 1px solid #E3EBFF;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.75);
    }
    .wecom-qr-inner {
      background: #fff;
      border: 1px solid #DCE7FF;
      border-radius: 12px;
      padding: 10px;
    }
    .wecom-qr-inner img {
      width: 100%;
      max-width: 210px;
      aspect-ratio: 1 / 1;
      display: block;
      margin: 0 auto;
      border-radius: 8px;
    }
    .wecom-note {
      font-size: 12px;
      color: #7B8799;
      line-height: 1.6;
      margin: 0;
    }
    @media (max-width: 380px) {
      .modal { padding: 20px 16px 16px; }
      .modal-title { font-size: 24px; }
      .wecom-steps { grid-template-columns: 1fr; }
    }
    .pillRow { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
    .pill { background: var(--pri2); color: var(--pri); padding: 4px 12px; border-radius: 8px; font-size: 13px; font-weight: 700; }
    .community-card {
      background: linear-gradient(180deg, #F8FAFF 0%, #F2F6FF 100%);
      border: 1px solid #E3EBFF;
      border-radius: 14px;
      padding: 16px;
      margin-top: 20px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.7);
    }

    .page {
      max-width: 420px;
      margin: 0 auto;
      padding: 20px 16px;
      background:
        radial-gradient(circle at 50% -10%, rgba(59,130,246,.12) 0%, rgba(59,130,246,0) 48%),
        linear-gradient(180deg, #F5F7FF 0%, #F2F5FC 100%);
      border-radius: 24px;
    }
    .panel-result { background: transparent; box-shadow: none; padding: 0; }
    .result-card {
      background: linear-gradient(180deg, #FFFFFF 0%, #FAFCFF 100%);
      border-radius: 22px;
      box-shadow: 0 12px 34px rgba(38, 84, 155, 0.10);
      border: 1px solid rgba(148, 182, 255, 0.30);
      padding: 24px;
    }
    .result-title {
      font-size: 12px;
      font-weight: 600;
      color: #9AA6BC;
      line-height: 1.2;
      margin: 0 0 20px;
      text-align: center;
      letter-spacing: 1px;
    }
    .result-type {
      font-size: 56px;
      font-weight: 900;
      letter-spacing: 2px;
      text-align: center;
      margin: 0 0 12px;
      color: #1D4ED8;
      line-height: 1;
      text-shadow: 0 8px 24px rgba(29, 78, 216, 0.18);
    }
    .result-name {
      font-size: 34px;
      font-weight: 800;
      text-align: center;
      margin: 0 0 16px;
      color: #111827;
      line-height: 1.25;
    }
    .result-line {
      font-size: 15px;
      color: #4B5563;
      text-align: center;
      max-width: 286px;
      margin: 0 auto 20px;
      line-height: 1.7;
    }
    .result-tags {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin: 0 0 28px;
    }
    .result-card .tag {
      min-height: 30px;
      padding: 0 14px;
      border-radius: 999px;
      background: linear-gradient(180deg, #F3F7FF 0%, #EAF1FF 100%);
      color: #1E40AF;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      font-weight: 700;
      border: 1px solid #D4E1FF;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);
    }
    .section-title {
      font-weight: 800;
      margin-bottom: 12px;
      font-size: 16px;
      color: #0F172A;
      letter-spacing: 0.2px;
    }
    .tips-card {
      background: linear-gradient(180deg, #F8FAFF 0%, #F2F6FF 100%);
      border-radius: 14px;
      border: 1px solid #E3EBFF;
      padding: 16px;
      margin-bottom: 24px;
    }
    .tips-card ul { list-style: none; padding: 0; margin: 0; }
    .tips-card li { padding-left: 26px; position: relative; margin-bottom: 12px; line-height: 1.75; color: #1F2937; font-size: 15px; }
    .tips-card li:last-child { margin-bottom: 0; }
    .tips-card li::before { content: 'ğŸ¾'; position: absolute; left: 0; top: 1px; font-size: 14px; }

    .avatar-wrap { display: flex; justify-content: center; margin: 8px 0 24px; }
    .avatar-circle { width: 96px; height: 96px; border-radius: 50%; overflow: hidden; border: 3px solid #3B82F6; background: #f3f5ff; flex-shrink: 0; cursor: pointer; transition: all 0.3s; position: relative; box-shadow: 0 8px 20px rgba(37,99,235,0.2); }
    .avatar-circle:hover { transform: scale(1.05); border-color: #2563EB; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
    .avatar-circle img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .avatar-circle::after { content: "ç‚¹å‡»æ›´æ¢"; position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; font-size: 11px; text-align: center; padding: 4px 0; opacity: 0; transition: opacity 0.3s; }
    .avatar-circle:hover::after { opacity: 1; }

    .btn-primary, .primary { height: 46px; border-radius: 14px; background: linear-gradient(90deg,#2563EB,#1D4ED8); color: #fff; }
    .btn-ghost, .ghost { height: 46px; border-radius: 14px; background: #fff; color: #1D4ED8; border: 1.5px solid #3B82F6; }
    .result-card .btns { margin-top: 12px; }
    .result-card .btns button {
      width: 100%;
      min-width: 100%;
      height: 48px;
      border-radius: 14px;
      font-size: 19px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .qr-card { background: #fff; border-radius: 16px; padding: 16px; display: flex; align-items: flex-end; justify-content: space-between; gap: 14px; border: 1px solid #F3F4F6; }
    .qr-text { flex: 1; }
    .qr-text .test-cta-title { font-size: 16px; font-weight: 800; color: #111827; margin-bottom: 6px; }
    .qr-text .test-cta-sub { font-size: 13px; color: #6B7280; line-height: 1.5; }
    .qr-code { width: 160px; height: 160px; flex-shrink: 0; }
    .qr-code img { width: 100%; height: 100%; display: block; object-fit: cover; }



    .poster-preview {
      display: none;
      margin-top: 16px;
      padding: 14px;
      border-radius: 18px;
      background: linear-gradient(180deg, #F8FAFF 0%, #F3F7FF 100%);
      border: 1px solid #E3EBFF;
      box-shadow: 0 10px 24px rgba(38,84,155,0.08);
    }
    .poster-preview.is-show { display: block; }
    .poster-preview-title {
      font-size: 14px;
      color: #1E40AF;
      font-weight: 800;
      margin-bottom: 4px;
      text-align: center;
      letter-spacing: 0.3px;
    }
    .poster-preview-sub {
      font-size: 12px;
      color: #64748B;
      text-align: center;
      margin-bottom: 10px;
      line-height: 1.5;
    }
    .poster-image-wrap {
      position: relative;
    }
    img#posterImg {
      display: none;
      width: 100%;
      border-radius: 18px;
      box-shadow: 0 10px 26px rgba(38,84,155,0.16);
      border: 1px solid #D8E4FF;
    }
    .poster-avatar-hotspot {
      display: none;
    }
    .save-tip {
      display: none;
      margin-top: 14px;
      min-height: 48px;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 12px 16px;
      background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
      border-radius: 14px;
      border: 1px solid #C7D2FE;
      color: #3730A3;
      font-size: 15px;
      font-weight: 800;
      line-height: 1.5;
      letter-spacing: 0.3px;
    }




  </style>

</head>
<body>
  <div class="wrap">
    <div class="card" id="hero">
      <div class="row">
        <div>
          <h1 class="title">èŒå® è”èŒ Â· æ¯›å­©å­MBTIæ€§æ ¼æµ‹è¯•</h1>
          <p class="sub">16 é¢˜ï¼Œ1 åˆ†é’Ÿææ‡‚ä½ å®¶æ¯›å­©å­çš„"é™ªä¼´å‹äººæ ¼"ï¼Œé¡ºä¾¿ç”Ÿæˆä¸€å¼ èƒ½æ™’çš„ç»“æœå¡ã€‚</p>
        </div>
        <div class="tag" id="statusTag">æœªå¼€å§‹</div>
      </div>
      <div class="progressBar"><div id="bar"></div></div>
      <div class="btns">
        <button class="primary" onclick="start()">å¼€å§‹æµ‹è¯•</button>
        <button class="ghost" onclick="showDemo()">çœ‹çœ‹ç¤ºä¾‹</button>
      </div>
      <p class="muted" style="margin-top:10px;">å®Œæˆåå¯åŠ å…¥ã€åŒå“ç§Ã—åŒæ€§æ ¼ã€‘æ¯›å­©å­é™ªä¼´ç¤¾ç¾¤</p>
      <p class="muted" style="margin-top:4px;">å°æç¤ºï¼šæŒ‰ä½ å®¶æ¯›å­©å­"æ—¥å¸¸æœ€å¸¸è§çŠ¶æ€"é€‰ï¼Œä¸ç”¨çº ç»“ä¸ªåˆ«ç‰¹ä¾‹ã€‚</p>
    </div>


    <div class="card" id="panel">
      <div class="row">
        <div class="tag" id="step">å‡†å¤‡ä¸­</div>
        <div class="tag" id="progress"></div>
      </div>
      <div class="hr"></div>
      <div id="content">
        <p class="muted">ç‚¹å‡»ã€Œå¼€å§‹æµ‹è¯•ã€è¿›å…¥ç¬¬ 1 é¢˜ã€‚</p>
      </div>
    </div>

    <div class="toast" id="toast">æµ‹è¯•ç»“æœå·²ç”Ÿæˆ</div>


  </div>

  <div class="modal-mask" id="wecomModal">
    <div class="modal">
      <span class="modal-close" onclick="closeWecomModal()">&times;</span>
      <div class="modal-title">åŠ å…¥åŒç±»æ¯›å­©å­åœˆ</div>
      <div class="modal-sub">å¾®ä¿¡å†…è¯†åˆ«äºŒç»´ç ï¼Œå‘é€ä½ çš„æ¯›å­©å­ç±»å‹å³å¯å…¥ç¾¤</div>
      <div class="wecom-type-chip">å½“å‰ç±»å‹ï¼š<b id="wecomTypeLabel">æ¯›å­©å­æ€§æ ¼</b></div>
      <div class="wecom-steps">
        <div class="wecom-step">1 é•¿æŒ‰è¯†åˆ«äºŒç»´ç </div>
        <div class="wecom-step">2 å‘é€ç±»å‹å¿«é€Ÿè¿›ç¾¤</div>
      </div>
      <div class="wecom-qr-box">
        <div class="wecom-qr-inner">
          <img src="wecom_qr.png" alt="ä¼ä¸šå¾®ä¿¡äºŒç»´ç " />
        </div>
      </div>
      <p class="wecom-note">å·²åŒ¹é…åŒå“ç§äº¤æµç¾¤ï¼Œå…¥ç¾¤åå¯é¢†å–ä¸“å±è®­ç»ƒæ¸…å•ã€‚</p>
    </div>

  </div>

  <!-- æµ·æŠ¥ç”Ÿæˆä¾èµ– -->

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>


<script>
  // 16é¢˜ï¼šæ¯ä¸ªç»´åº¦4é¢˜ï¼ˆæ¯›å­©å­å‘ï¼‰

  // ç»´åº¦ï¼šE/I, S/N, T/F, J/P
  const questions = [
    // E/I
    { id:"E1", dim:"EI", q:"å®¶é‡Œæ¥äº†æ–°å®¢äººï¼ŒTAæ›´å¸¸ï¼š", A:"çƒ­æƒ…å‡‘è¿‘é—»ä¸€é—»ï¼Œæƒ³ç¤¾äº¤", B:"å…ˆé€€åè§‚å¯Ÿï¼Œç¡®è®¤å®‰å…¨å†é è¿‘", scoreA:{E:1}, scoreB:{I:1}},
    { id:"E2", dim:"EI", q:"æ•£æ­¥è·¯ä¸Šé‡åˆ°åˆ«çš„æ¯›å­©å­ï¼ŒTAæ›´åƒï¼š", A:"ä¸»åŠ¨æ¥è¿‘ï¼Œæƒ³æ‰“æ‹›å‘¼", B:"æ›´æ„¿æ„è´´ç€ä½ èµ°ï¼Œä¸å¤ªæ­ç†", scoreA:{E:1}, scoreB:{I:1}},
    { id:"E3", dim:"EI", q:"ä½ å›å®¶å¼€é—¨é‚£ä¸€åˆ»ï¼ŒTAé€šå¸¸ï¼š", A:"å†²æ¥è¿æ¥ï¼Œæƒ…ç»ªæ‹‰æ»¡", B:"å…ˆçœ‹å‡ ç§’ï¼Œç­‰ä½ æ‹›å‘¼å†é è¿‘", scoreA:{E:1}, scoreB:{I:1}},
    { id:"E4", dim:"EI", q:"åœ¨é™Œç”Ÿç¯å¢ƒé‡Œï¼ŒTAæ›´å¯èƒ½ï¼š", A:"è¶Šçƒ­é—¹è¶Šå…´å¥‹ï¼Œåˆ°å¤„æ¢ç´¢", B:"æ‰¾ä¸ªå®‰å…¨ç‚¹çš„ä½ç½®æ…¢æ…¢é€‚åº”", scoreA:{E:1}, scoreB:{I:1}},
    // S/N
    { id:"S1", dim:"SN", q:"åˆ°æ–°åœ°æ–¹ï¼ŒTAæœ€å…ˆæ²‰è¿·çš„æ˜¯ï¼š", A:"åœ°ä¸Šå„ç§å‘³é“ä¸ç»†èŠ‚çº¿ç´¢", B:"æ•´ä½“æ°›å›´ï¼Œå“ªé‡Œå¯èƒ½æœ‰æ–°ç©æ³•", scoreA:{S:1}, scoreB:{N:1}},
    { id:"S2", dim:"SN", q:"ç»™TAæ–°ç©å…·ï¼ŒTAæ›´åƒï¼š", A:"ç ”ç©¶ç»“æ„ï¼šå’¬å“ªå„¿ã€æ€ä¹ˆç©æœ€é¡ºæ‰‹", B:"ç©æ³•å‘æ•£ï¼šå®ƒè¿˜èƒ½æ€ä¹ˆâ€œæ•´æ´»â€", scoreA:{S:1}, scoreB:{N:1}},
    { id:"S3", dim:"SN", q:"å­¦æ–°æŒ‡ä»¤æ—¶ï¼ŒTAæ›´å®¹æ˜“ï¼š", A:"é é‡å¤ç»ƒä¹ ç¨³ç¨³å­¦ä¼š", B:"å­¦ä¼šåä¼šä¸¾ä¸€åä¸‰è‡ªå·±å‘æŒ¥", scoreA:{S:1}, scoreB:{N:1}},
    { id:"S4", dim:"SN", q:"ä½ æŠŠé£Ÿç›†/çªä½ç½®æ¢äº†ï¼ŒTAä¼šï¼š", A:"ç«‹åˆ»å‘ç°ï¼šå’¦æ€ä¹ˆä¸åœ¨è€åœ°æ–¹", B:"æ— æ‰€è°“ï¼šåæ­£æœ€åéƒ½èƒ½æ‰¾åˆ°", scoreA:{S:1}, scoreB:{N:1}},
    // T/F
    { id:"T1", dim:"TF", q:"TAçŠ¯é”™è¢«ä½ åˆ¶æ­¢åï¼ŒTAæ›´åƒï¼š", A:"å…ˆåˆ¤æ–­è§„åˆ™ï¼šè¿™äº‹åˆ°åº•èƒ½ä¸èƒ½åš", B:"å…ˆçœ‹ä½ æƒ…ç»ªï¼šä½ æ˜¯ä¸æ˜¯ç”Ÿæ°”äº†", scoreA:{T:1}, scoreB:{F:1}},
    { id:"T2", dim:"TF", q:"è®­ç»ƒæ—¶TAæ›´åƒå“ªå¥—ï¼š", A:"æŒ‡ä»¤æ¸…æ™°+è§„åˆ™ä¸€è‡´ï¼Œå­¦å¾—æ›´å¿«", B:"å¤šå¤¸å¤šå“„å¤šå¥–åŠ±ï¼ŒçŠ¶æ€æ›´å¥½", scoreA:{T:1}, scoreB:{F:1}},
    { id:"T3", dim:"TF", q:"ä½ å¿ƒæƒ…ä¸å¤ªå¥½æ—¶ï¼ŒTAæ›´å¸¸ï¼š", A:"ç”¨è¡ŒåŠ¨è§£å†³ï¼šå¼ç©å…·/æ‹‰ä½ å»ç©", B:"æƒ…ç»ªé™ªä¼´ï¼šè´´è´´/å®ˆåœ¨ä½ æ—è¾¹", scoreA:{T:1}, scoreB:{F:1}},
    { id:"T4", dim:"TF", q:"é‡åˆ°åˆ«çš„æ¯›å­©å­æŠ¢ç©å…·ï¼ŒTAæ›´å¯èƒ½ï¼š", A:"äº‰å¤º/åšæŒï¼šæˆ‘çš„å°±æ˜¯æˆ‘çš„", B:"é€€ä¸€æ­¥/æ±‚åŠ©ä½ ï¼šåˆ«åµåˆ«åµ", scoreA:{T:1}, scoreB:{F:1}},
    // J/P
    { id:"J1", dim:"JP", q:"æ—¥å¸¸ä½œæ¯ä¸Šï¼ŒTAæ›´åƒï¼š", A:"è§„å¾‹æ´¾ï¼šåˆ°ç‚¹åƒåˆ°ç‚¹ç¡", B:"éšç¼˜æ´¾ï¼šçœ‹å¿ƒæƒ…å†³å®šä»Šå¤©èŠ‚å¥", scoreA:{J:1}, scoreB:{P:1}},
    { id:"J2", dim:"JP", q:"ä½ æ‹¿å‡ºç‰µå¼•ç»³è¦å‡ºé—¨ï¼ŒTAé€šå¸¸ï¼š", A:"ç«‹åˆ»è¿›å…¥çŠ¶æ€ï¼Œå‡†å¤‡å‡ºå‘", B:"çœ‹å¿ƒæƒ…ï¼šæœ‰æ—¶å…´å¥‹æœ‰æ—¶è£…æ­»", scoreA:{J:1}, scoreB:{P:1}},
    { id:"J3", dim:"JP", q:"ç©â€œå¼å›â€ä¹‹ç±»çš„æ¸¸æˆï¼ŒTAæ›´åƒï¼š", A:"æŒ‰æµç¨‹ï¼šå¼æ¥-æ”¾ä¸‹-å†æ¥", B:"éšæ—¶æ”¹è§„åˆ™ï¼šçªç„¶è·‘å/æ•´æ´»", scoreA:{J:1}, scoreB:{P:1}},
    { id:"J4", dim:"JP", q:"å‡ºé—¨è·¯çº¿æ¢äº†ï¼ŒTAæ›´åƒï¼š", A:"æœ‰ç‚¹ä¸çˆ½ï¼šæ€ä¹ˆä¸èµ°è€è·¯ï¼Ÿ", B:"æ›´å¼€å¿ƒï¼šæ¢è·¯=æ–°çš„ä¸–ç•Œï¼", scoreA:{J:1}, scoreB:{P:1}}
  ];

  // 16å‹ç»“æœåº“ï¼ˆä¸­æ–‡å+é‡‘å¥+å»ºè®®+æ ‡ç­¾ï¼‰
  const results = {
    "ENFP": { name:"å¿«ä¹ç¤¾äº¤å°æ—‹é£", line:"äººè§äººçˆ±ï¼Œä½†ç²¾åŠ›åƒæ°¸åŠ¨æœºã€‚", tags:["ç¤¾äº¤è¾¾äºº","é«˜å…´å¥‹","éœ€è¦æ”¾ç”µ"],
      tips:["æ¯å¤©ä¸¤æ¬¡é«˜è´¨é‡æ”¾ç”µï¼ˆå—…é—»+è¿½é€ï¼‰","ç¤¾äº¤è¦â€œæœ‰è¾¹ç•Œâ€ï¼Œé¿å…è¿‡åº¦åˆºæ¿€","è®­ç»ƒçŸ­é¢‘å¿«ï¼Œå¤šç”¨å¥–åŠ±"] },
    "ENFJ": { name:"è´´å¿ƒå›¢å® å“„å“„å®˜", line:"ä¼šè¯»ç©ºæ°”ï¼Œè¿˜ç‰¹åˆ«ä¼šå“„äººã€‚", tags:["æƒ…ç»ªæ„ŸçŸ¥","ç²˜äººæš–å¿ƒ","é…åˆåº¦é«˜"],
      tips:["å¤šç”¨å¤¸å¥–ä¸æŠšæ‘¸å»ºç«‹å®‰å…¨æ„Ÿ","å®‰æ’ç¨³å®šç¤¾äº¤ï¼šç†Ÿäºº+å›ºå®šåœºåœ°","ç»™å®ƒä¸€ä¸ªâ€œé™ªä¼´å²—ä½â€ï¼ˆå¦‚é—¨å£è¿æ¥ï¼‰"] },
    "ENTP": { name:"ç‚¹å­ç‹æ‹†å®¶å¤§å¸ˆ", line:"èªæ˜åˆ°å¯æ€•ï¼Œé—²ç€å°±æƒ³æ•´æ´»ã€‚", tags:["é«˜æ™ºå•†","å¥½å¥‡å¿ƒ","çˆ±æŒ‘æˆ˜"],
      tips:["ç”¨ç›Šæ™ºç©å…·/å¯»å®æ¸¸æˆæ¶ˆè€—è„‘åŠ›","è®­ç»ƒå¢åŠ éš¾åº¦ï¼šå˜æ¢åœºæ™¯/å¹²æ‰°","å®¶é‡Œåšå¥½é˜²å’¬ä¸æ›¿ä»£ç‰©ï¼ˆå’¬èƒ¶ï¼‰"] },
    "ENTJ": { name:"è§„åˆ™æ‰§è¡Œé˜Ÿé•¿", line:"æœ‰ä¸»è§ã€æœ‰ç§©åºï¼Œæƒ³å½“è€å¤§ã€‚", tags:["å¼ºç›®æ ‡","æ‰§è¡ŒåŠ›","ä¸»å¯¼å‹"],
      tips:["è§„åˆ™ä¸€è‡´ï¼Œå£ä»¤ç»Ÿä¸€ï¼ˆå®¶é‡Œæ‰€æœ‰äººï¼‰","ç”¨ä»»åŠ¡é©±åŠ¨ï¼šåä¸‹â†’ç­‰å¾…â†’å¥–åŠ±","æ—©æœŸç¤¾äº¤è®­ç»ƒé¿å…å†²çªå‡çº§"] },

    "ESFP": { name:"æ´¾å¯¹æ°”æ°›ç»„ç»„é•¿", line:"å“ªé‡Œçƒ­é—¹å»å“ªï¼Œå¿«ä¹ä¸è®¾é˜²ã€‚", tags:["å¤–å‘","çˆ±ç©","é«˜äº’åŠ¨"],
      tips:["å¤šå®‰æ’äº’åŠ¨æ¸¸æˆï¼šé£ç›˜/æ‹”æ²³ï¼ˆæœ‰è§„åˆ™ï¼‰","é¿å…è¿‡åº¦å…´å¥‹ï¼šç©å‰å…ˆåä¸‹ç­‰å¾…","ç¤¾äº¤åç»™å®‰é™ä¼‘æ¯æ—¶é—´"] },
    "ESFJ": { name:"å®¶åº­æ°›å›´å®ˆæŠ¤è€…", line:"å°±çˆ±è·Ÿç€ä½ ï¼Œå®¶é‡Œè°éƒ½è¦ç®¡ã€‚", tags:["é»äºº","æŠ¤å®¶","å¥½é…åˆ"],
      tips:["ç»™ç¨³å®šä½œæ¯ä¸å›ºå®šä»ªå¼æ„Ÿ","åˆ†ç¦»è®­ç»ƒè¦å¾ªåºæ¸è¿›ï¼ˆçŸ­æ—¶ç¦»å¼€ï¼‰","å¤šåšâ€œé™ªä¼´å‹ä»»åŠ¡â€æå‡æ»¡è¶³æ„Ÿ"] },
    "ESTP": { name:"å†²é”‹æ¢ç´¢è¡ŒåŠ¨æ´¾", line:"å…ˆå¹²å†è¯´ï¼Œè¡ŒåŠ¨æ°¸è¿œå¿«ä¸€æ­¥ã€‚", tags:["è¡ŒåŠ¨æ´¾","èƒ†å­å¤§","çˆ±æ¢ç´¢"],
      tips:["å¤–å‡ºä¼˜å…ˆâ€œå—…é—»+æ¢ç´¢â€å†è®­ç»ƒ","ç”¨ç»³æ§ä¸å›å«å»ºç«‹è¾¹ç•Œ","ç»™å†²åˆºå‹è¿åŠ¨ï¼ˆçŸ­è·‘/è¿½é€ï¼‰"] },
    "ESTJ": { name:"çºªå¾‹å§”å‘˜å°è­¦é•¿", line:"æœ€æ‡‚è§„çŸ©ï¼Œä¹Ÿæœ€ä¼šâ€œç›¯äººâ€ã€‚", tags:["ç¨³å®š","è®²è§„åˆ™","è¾¹ç•Œæ¸…æ™°"],
      tips:["è®­ç»ƒè¦æ ‡å‡†åŒ–ï¼šå£ä»¤+æ‰‹åŠ¿å›ºå®š","é€‚åˆå­¦ä¹ æŠ€å·§ï¼šå®šç‚¹ã€ç­‰å¾…ã€éšè¡Œ","ç¤¾äº¤å†²çªæ—¶å…ˆè®©å®ƒâ€œåä¸‹å†·é™â€"] },

    "INFP": { name:"ç»ç’ƒå¿ƒæµªæ¼«é™ªä¼´è€…", line:"æ•æ„Ÿåˆæ·±æƒ…ï¼Œåªè®¤è‡ªå·±äººã€‚", tags:["æ•æ„Ÿ","ä¾æ‹","æ…¢çƒ­"],
      tips:["å‡å°‘å¼ºè¡Œç¤¾äº¤ï¼Œç”¨â€œè·ç¦»+å¥–åŠ±â€å»ºç«‹ä¿¡ä»»","ç»™å®‰å…¨åŒºï¼šçª/ç¬¼/è§’è½","ç”¨æ¸©å’Œè®­ç»ƒæ–¹å¼ï¼Œé¿å…å¤§å£°å‘µæ–¥"] },
    "INFJ": { name:"ç¥ç§˜æ²»æ„ˆç³»å®ˆæŠ¤è€…", line:"å®‰é™è§‚å¯Ÿï¼Œä½†å…³é”®æ—¶åˆ»å¾ˆé è°±ã€‚", tags:["è§‚å¯Ÿå‹","ç²˜ä½ ","æœ‰åˆ†å¯¸"],
      tips:["å›ºå®šä½œæ¯ä¸åœºæ™¯ï¼Œå®‰å…¨æ„Ÿæ›´å¼º","è®­ç»ƒç”¨â€œæç¤ºâ†’æˆåŠŸâ†’å¥–åŠ±â€ï¼›ç¤¾äº¤ä»¥ç†Ÿäººå±€ä¸ºä¸»ï¼Œæ…¢æ…¢æ‰©åœˆ"] },
    "INTP": { name:"ç ”ç©¶å‹å¥½å¥‡å®å®", line:"çˆ±ç ”ç©¶ï¼Œåƒä¸ªå°ç§‘å­¦å®¶ã€‚", tags:["ç‹¬ç«‹","å¥½å¥‡","è„‘åŠ›å‹"],
      tips:["å¤šç»™ç›Šæ™ºç©å…·ã€å—…é—»å«ã€å¯»å®","è®­ç»ƒåŠ å…¥å˜åŒ–ï¼Œä¸ç„¶ä¼šæ— èŠ","ç”¨å¥–åŠ±å»ºç«‹â€œæ„¿æ„é…åˆâ€çš„åŠ¨åŠ›"] },
    "INTJ": { name:"é«˜æ™ºå•†ç­–ç•¥å®¶", line:"ä¸åµä¸é—¹ï¼Œä½†å¿ƒé‡Œé—¨å„¿æ¸…ã€‚", tags:["å†·é™","ç­–ç•¥","è‡ªæ§å¼º"],
      tips:["è§„åˆ™æ˜ç¡®ã€è¾¹ç•Œæ¸…æ™°ï¼Œå°‘åå¤","è®­ç»ƒåâ€œä»»åŠ¡å‹â€ï¼šå®šç‚¹/éšè¡Œ","ç¤¾äº¤å…ˆè§‚å¯Ÿï¼Œåˆ«å‚¬ï¼Œç»™å®ƒé€‰æ‹©æƒ"] },

    "ISFP": { name:"æ¸©æŸ”æ•æ„Ÿå°è‰ºæœ¯å®¶", line:"æ¸©æŸ”åˆæŒ‘å‰”ï¼Œå–œæ¬¢èˆ’æœçš„èŠ‚å¥ã€‚", tags:["æ¸©æŸ”","æ…¢çƒ­","äº«å—å‹"],
      tips:["ç¯å¢ƒèˆ’é€‚æœ€é‡è¦ï¼šæ¸©åº¦ã€å«å­ã€å™ªéŸ³","è®­ç»ƒç”¨é¼“åŠ±æ›¿ä»£å‹åŠ›","å¤–å‡ºåˆ«å¤ªä¹…ï¼Œç»™è¶³ä¼‘æ¯"] },
    "ISFJ": { name:"æš–å¿ƒè´´è´´ä¿å§†å‹", line:"ä¸äº‰ä¸æŠ¢ï¼Œå°±æƒ³å®ˆç€ä½ ã€‚", tags:["è´´å¿ƒ","ç¨³å®š","é¡¾å®¶"],
      tips:["é€‚åˆè§„å¾‹é™ªä¼´ï¼šå›ºå®šæ•£æ­¥æ—¶é—´","åšåˆ†ç¦»è®­ç»ƒé¿å…ä¾èµ–è¿‡å¼º","ç”¨è½»æ¾äº’åŠ¨ï¼ˆæŠšæ‘¸/èˆ”é£Ÿï¼‰å®‰æŠš"] },
    "ISTP": { name:"å†·é™ç‹¬è¡Œè§‚å¯Ÿå‘˜", line:"ç‹¬ç«‹ã€è‡ªæ´½ï¼Œä¸çˆ±è¢«æ‰“æ‰°ã€‚", tags:["ç‹¬ç«‹","å†·é™","è§‚å¯Ÿ"],
      tips:["ç»™ç©ºé—´ï¼šåˆ«ä¸€ç›´æŠ±ã€åˆ«å¼ºäº’åŠ¨","è®­ç»ƒç”¨â€œå°‘è¯´å¤šåšâ€ï¼šåŠ¨ä½œæ˜ç¡®","ç¤¾äº¤å°‘è€Œç²¾ï¼Œé¿å…è¿‡åº¦æ¶ˆè€—"] },
    "ISTJ": { name:"ç¨³å®šå¯é è€å¹²éƒ¨", line:"ç¨³ã€å‡†ã€ç‹ ï¼šæŒ‰è§„çŸ©æ¥æœ€èˆ’æœã€‚", tags:["ç¨³é‡","å®ˆè§„åˆ™","ä½æ³¢åŠ¨"],
      tips:["å›ºå®šè§„åˆ™+å›ºå®šè·¯çº¿ï¼Œæœ€çœå¿ƒ","è®­ç»ƒé‡â€œé‡å¤ä¸ä¸€è‡´æ€§â€","é€‚åˆåšåŸºç¡€æœä»ï¼šç­‰å¾…/éšè¡Œ/å›å«"] }
  };

  let idx = -1;
  let score = {E:0,I:0,S:0,N:0,T:0,F:0,J:0,P:0};
  let finalType = "";

  // è¿™é‡Œçš„ YOUR_TEST_LINK é»˜è®¤ç›´æ¥ç”¨å½“å‰é¡µé¢åœ°å€
  const getTestLink = () => location.href.split('?')[0];

  function start(){
    idx = 0;
    score = {E:0,I:0,S:0,N:0,T:0,F:0,J:0,P:0};
    document.getElementById("hero").style.display = "none";
    document.getElementById("panel").style.display = "block";
    document.getElementById("statusTag").innerText = "æµ‹è¯•è¿›è¡Œä¸­";
    renderQuestion();
  }

  function showDemo(){
    start(); // å…ˆåˆ‡æ¢æ˜¾ç¤º
    idx = 16; // æ¨¡æ‹Ÿç»“æŸ
    renderResult("ENFP");
  }

  function renderQuestion(){

    const q = questions[idx];
    const panel = document.getElementById("panel");
    if(panel) panel.classList.remove("panel-result");
    document.getElementById("step").innerText = "é¢˜ç›®è¿›åº¦";
    document.getElementById("progress").innerText = `${idx+1}/${questions.length}`;
    setBar((idx)/questions.length);

    document.getElementById("content").innerHTML = `
      <div class="q">${q.q}</div>
      <button class="opt" onclick="choose('A')">A. ${q.A}</button>
      <button class="opt" onclick="choose('B')">B. ${q.B}</button>
      <div class="muted" style="text-align:center;margin-top:10px;font-size:12px;">å®Œæˆåå¯åŠ å…¥ã€åŒå“ç§Ã—åŒæ€§æ ¼ã€‘æ¯›å­©å­é™ªä¼´ç¤¾ç¾¤</div>
    `;

  }

  function choose(which){
    const q = questions[idx];
    const s = (which === "A") ? q.scoreA : q.scoreB;
    Object.keys(s).forEach(k => score[k] += s[k]);

    idx += 1;
    if(idx >= questions.length){
      finalType = calcType();
      renderResult(finalType);
    }else{
      renderQuestion();
    }
  }

  function calcType(){
    const EI = (score.E >= score.I) ? "E" : "I";
    const SN = (score.S >= score.N) ? "S" : "N";
    const TF = (score.T >= score.F) ? "T" : "F";
    const JP = (score.J >= score.P) ? "J" : "P";
    return EI+SN+TF+JP;
  }

  const subTitles = {
    E: "æ®è¯´è¿™ç§æ¯›å­©å­åœ¨ç¾¤é‡Œæœ€å—æ¬¢è¿ğŸ˜†",
    I: "å¤–å†·å†…çƒ­çš„å°ç”œå¿ƒå°±æ˜¯å®ƒå§âœ¨",
    S: "ç¨³é‡å¯é çš„å®¶åº­å°å«å£«ğŸ¶",
    N: "è„‘å›è·¯æ¸…å¥‡çš„æœºçµé¬¼æœ¬é¬¼ğŸ§ "
  };

  const AVATAR_KEY = "dog_mbti_avatar";
  const DEFAULT_AVATAR = "touxiang.png.jpg";

  function getAvatar(){
    try{ return localStorage.getItem(AVATAR_KEY) || DEFAULT_AVATAR; }
    catch(e){ return DEFAULT_AVATAR; }
  }

  function applyAvatar(){
    const avatarUrl = getAvatar();
    const img = document.getElementById("avatarImg");
    const imgPoster = document.getElementById("avatarImgPoster");
    if(img) img.src = avatarUrl;
    if(imgPoster) imgPoster.src = avatarUrl;
  }

  function openAvatarPicker(){
    const input = document.getElementById("avatarInput");
    if(input){ input.value = ""; input.click(); }
  }
  
  function clickAvatar(){
    openAvatarPicker();
  }

  function handleAvatarChange(e){
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      const dataUrl = ev.target.result;
      if(typeof dataUrl === "string"){
        try{ localStorage.setItem(AVATAR_KEY, dataUrl); }catch(err){}
        applyAvatar();
        const preview = document.getElementById("posterPreview");
        if(preview && preview.classList.contains("is-show")){
          savePoster({
            autoDownload: false,
            showLoadingToast: false,
            showSuccessToast: true,
            scrollToPreview: false,
            refreshOnly: true
          });
        }
      }
    };
    reader.readAsDataURL(file);
  }

  function renderResult(type){

    const r = results[type] || results["ENFP"];
    document.getElementById("statusTag").innerText = "å·²å‡ºç»“æœ";
    document.getElementById("step").innerText = "æµ‹è¯•å®Œæˆ";
    document.getElementById("progress").innerText = "";
    setBar(1);


    const tipsHtml = r.tips.slice(0, 3).map(t=>`<li>${t}</li>`).join("");
    const tagsHtml = r.tags.map(t=>`<span class="tag">${t}</span>`).join("");

    const panel = document.getElementById("panel");
    if(panel) panel.classList.add("panel-result");

    document.getElementById("content").innerHTML = `
      <div class="page">
        <div class="result-card">
          <div class="result-title">æµ‹è¯•ç»“æœ</div>

          <div class="avatar-wrap">
              <div class="avatar-circle" onclick="clickAvatar()">
                  <img id="avatarImg" alt="å¤´åƒ" />
              </div>
              <input id="avatarInput" type="file" accept="image/*" style="display:none" onchange="handleAvatarChange(event)" />
          </div>

          <div class="result-type">${type}</div>
          <div class="result-name">${r.name}</div>
          <div class="result-line">"${r.line}"</div>

          <div class="result-tags">${tagsHtml}</div>
          
          <div class="section-title">ä¸“å±å…»å® å»ºè®®</div>
          <div class="tips-card">
            <ul>${tipsHtml}</ul>
          </div>

          <div class="hr"></div>

          <div class="btns">
            <button class="btn-primary" onclick="savePoster()">ç”Ÿæˆç»“æœå›¾</button>
          </div>

          <div class="btns">
            <button class="btn-ghost" onclick="start()">é‡æ–°æµ‹è¯•</button>
          </div>

          <div id="posterPreview" class="poster-preview">
            <div class="poster-preview-title">å·²ç”Ÿæˆåˆ†äº«æµ·æŠ¥</div>
            <div class="poster-preview-sub">é•¿æŒ‰ä¿å­˜åå¯åˆ†äº«åˆ°æœ‹å‹åœˆ/ç¾¤</div>
            <div class="poster-image-wrap">
              <img id="posterImg" />
              <button id="posterAvatarHotspot" class="poster-avatar-hotspot" type="button" aria-label="ç‚¹å‡»æ›´æ¢å¤´åƒ" onclick="openAvatarPicker()"></button>
            </div>
            <div id="saveTip" class="save-tip">
              ğŸ‘† <b>é•¿æŒ‰ä¿å­˜å¹¶åˆ†äº«</b>
            </div>
          </div>

          <div class="community-card">
            <div style="font-weight:900; color:var(--pri); font-size:15px; margin-bottom:4px;">è§£é”åŒç±»åœˆå­</div>
            <div class="muted" style="font-size:12px; margin-bottom:12px;">æ‰«ç åŠ ä¼å¾®ï¼Œå‘æˆ‘"å“ç§å’Œæ€§æ ¼"æ‹‰ä½ è¿›ç¾¤</div>
            <button class="btn-primary small" style="width:100%; padding:10px;" onclick="showWecomModal()">åŠ ä¼å¾®é¢†å–å…¥ç¾¤ç </button>
          </div>
        </div>
      </div>
    `;





    // å¤´åƒæ¸²æŸ“
    applyAvatar();

    // æ¸²æŸ“äºŒç»´ç 
    renderQRCode(getTestLink());
  }


  let hasShownWecomModal = false;

  function showWecomModal() {
    const typeLabel = document.getElementById("wecomTypeLabel");
    if(typeLabel) typeLabel.innerText = finalType || "æ¯›å­©å­æ€§æ ¼";
    document.getElementById("wecomModal").style.display = "flex";
  }

  function closeWecomModal() {
    document.getElementById("wecomModal").style.display = "none";
  }

  document.addEventListener("click", function(e){
    const mask = document.getElementById("wecomModal");
    if(mask && e.target === mask) closeWecomModal();
  });

  function renderQRCode(url){
    // ç¡®ä¿ url æ˜¯å¯è®¿é—®çš„ http/https åœ°å€ï¼Œfile:// åè®®ä¼šå½±å“éƒ¨åˆ†æ‰«ç å™¨
    const validUrl = url.startsWith('http') ? url : 'https://dog-mbti-test.pages.dev'; // å…œåº•çº¿ä¸Šåœ°å€
    
    const container = document.getElementById("qrcode");

    if(!container) return;
    container.innerHTML = "";
    new QRCode(container, {
      text: validUrl,
      width: 96,
      height: 110,
      colorDark : "#1a1a1a",
      colorLight : "#ffffff",
      correctLevel : QRCode.Level ? QRCode.Level.H : 3 // QRCode.Level å¯èƒ½ä¸å­˜åœ¨ï¼ŒLevel.H å¯¹åº” 3
    });
  }

  // åŠ è½½å›¾ç‰‡çš„è¾…åŠ©å‡½æ•°
  function loadImg(src){
    return new Promise(function(resolve){
      if(!src) return resolve(null);
      var img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = function(){ resolve(img); };
      img.onerror = function(){ resolve(null); };
      img.src = src;
      setTimeout(function(){ resolve(null); }, 5000);
    });
  }

  async function savePoster(options = {}){
    try{
      const opts = {
        autoDownload: true,
        showLoadingToast: true,
        showSuccessToast: true,
        scrollToPreview: true,
        refreshOnly: false,
        ...options
      };

      if(opts.showLoadingToast){
        toast(opts.refreshOnly ? "æ­£åœ¨æ›´æ–°æµ·æŠ¥..." : "æµ·æŠ¥ç”Ÿæˆä¸­...");
      }

      const type = finalType || "ENFP";
      const r = results[type] || results["ENFP"];

      // ç”¨çº¯ Canvas ç»˜åˆ¶æµ·æŠ¥ï¼Œä¸ä¾èµ– html2canvas
      const W = 450, H = 800, S = 2;
      const canvas = document.createElement("canvas");
      canvas.width = W * S;
      canvas.height = H * S;
      const ctx = canvas.getContext("2d");
      ctx.scale(S, S);

      // èƒŒæ™¯
      const bgGrad = ctx.createLinearGradient(0, 0, 0, H);
      bgGrad.addColorStop(0, "#EFF4FF");
      bgGrad.addColorStop(0.4, "#FFFFFF");
      bgGrad.addColorStop(0.7, "#FFFFFF");
      bgGrad.addColorStop(1, "#F5F8FF");
      ctx.fillStyle = bgGrad;

      // åœ†è§’çŸ©å½¢èƒŒæ™¯
      const radius = 26;
      ctx.beginPath();
      ctx.moveTo(radius, 0);
      ctx.lineTo(W - radius, 0);
      ctx.quadraticCurveTo(W, 0, W, radius);
      ctx.lineTo(W, H - radius);
      ctx.quadraticCurveTo(W, H, W - radius, H);
      ctx.lineTo(radius, H);
      ctx.quadraticCurveTo(0, H, 0, H - radius);
      ctx.lineTo(0, radius);
      ctx.quadraticCurveTo(0, 0, radius, 0);
      ctx.closePath();
      ctx.fill();
      ctx.save();
      ctx.clip();

      // é¡¶éƒ¨æ¸å˜æ¡
      const barGrad = ctx.createLinearGradient(0, 0, W, 0);
      barGrad.addColorStop(0, "#3B82F6");
      barGrad.addColorStop(0.5, "#6366F1");
      barGrad.addColorStop(1, "#8B5CF6");
      ctx.fillStyle = barGrad;
      ctx.fillRect(0, 0, W, 5);

      // å“ç‰Œæ–‡å­—
      ctx.fillStyle = "#94A3B8";
      ctx.font = "600 12px -apple-system, 'PingFang SC', sans-serif";
      ctx.textAlign = "center";
      ctx.fillText("èŒå® è”èŒ Â· æ¯›å­©å­MBTI", W / 2, 36);

      // å¤´åƒ
      let avatarY = 52;
      const avatarSize = 120;
      const avatarSrc = getAvatar();
      const avatarImg = await loadImg(avatarSrc);
      if(avatarImg){
        ctx.save();
        ctx.beginPath();
        ctx.arc(W / 2, avatarY + avatarSize / 2, avatarSize / 2, 0, Math.PI * 2);
        ctx.closePath();
        ctx.clip();
        ctx.drawImage(avatarImg, W / 2 - avatarSize / 2, avatarY, avatarSize, avatarSize);
        ctx.restore();
        // å¤´åƒè¾¹æ¡†
        ctx.strokeStyle = "rgba(59, 130, 246, 0.35)";
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(W / 2, avatarY + avatarSize / 2, avatarSize / 2, 0, Math.PI * 2);
        ctx.stroke();
      }

      // MBTI ç±»å‹å¤§å­—
      let curY = avatarY + avatarSize + 30;
      ctx.fillStyle = "#1D4ED8";
      ctx.font = "900 72px -apple-system, 'PingFang SC', sans-serif";
      ctx.textAlign = "center";
      ctx.fillText(type, W / 2, curY);

      // åç§°
      curY += 40;
      ctx.fillStyle = "#111827";
      ctx.font = "800 28px -apple-system, 'PingFang SC', sans-serif";
      ctx.fillText(r.name, W / 2, curY);

      // é‡‘å¥
      curY += 36;
      ctx.fillStyle = "#475569";
      ctx.font = "italic 16px -apple-system, 'PingFang SC', sans-serif";
      ctx.fillText('"' + r.line + '"', W / 2, curY);

      // æ ‡ç­¾è¯ä¸¸
      curY += 32;
      const pills = r.tags.slice(0, 3);
      const pillFont = "700 14px -apple-system, 'PingFang SC', sans-serif";
      ctx.font = pillFont;
      const pillPad = 14, pillGap = 10, pillH = 30;
      let totalPillW = 0;
      const pillWidths = pills.map(function(t){
        const w = ctx.measureText(t).width + pillPad * 2;
        totalPillW += w;
        return w;
      });
      totalPillW += (pills.length - 1) * pillGap;
      let pillX = (W - totalPillW) / 2;
      pills.forEach(function(t, i){
        const pw = pillWidths[i];
        // è¯ä¸¸èƒŒæ™¯
        ctx.fillStyle = "#EEF2FF";
        ctx.beginPath();
        const pr = pillH / 2;
        ctx.moveTo(pillX + pr, curY);
        ctx.lineTo(pillX + pw - pr, curY);
        ctx.quadraticCurveTo(pillX + pw, curY, pillX + pw, curY + pr);
        ctx.quadraticCurveTo(pillX + pw, curY + pillH, pillX + pw - pr, curY + pillH);
        ctx.lineTo(pillX + pr, curY + pillH);
        ctx.quadraticCurveTo(pillX, curY + pillH, pillX, curY + pr);
        ctx.quadraticCurveTo(pillX, curY, pillX + pr, curY);
        ctx.fill();
        // è¯ä¸¸è¾¹æ¡†
        ctx.strokeStyle = "#C7D2FE";
        ctx.lineWidth = 1;
        ctx.stroke();
        // è¯ä¸¸æ–‡å­—
        ctx.fillStyle = "#3730A3";
        ctx.font = pillFont;
        ctx.textAlign = "center";
        ctx.fillText(t, pillX + pw / 2, curY + pillH / 2 + 5);
        pillX += pw + pillGap;
      });

      // åº•éƒ¨åˆ†å‰²çº¿
      const footerY = H - 140;
      ctx.strokeStyle = "#CBD5E1";
      ctx.lineWidth = 1;
      ctx.globalAlpha = 0.5;
      ctx.beginPath();
      ctx.moveTo(W * 0.2, footerY);
      ctx.lineTo(W * 0.8, footerY);
      ctx.stroke();
      ctx.globalAlpha = 1;

      // åº•éƒ¨äºŒç»´ç 
      const qrSize = 80;
      const qrX = W / 2 - 120;
      const qrY = footerY + 20;
      const qrImg = await loadImg("test_site_qr.png");
      if(qrImg){
        // äºŒç»´ç ç™½åº•
        ctx.fillStyle = "#FFFFFF";
        ctx.strokeStyle = "#E2E8F0";
        ctx.lineWidth = 1;
        const qrPad = 4;
        const qrBoxR = 10;
        ctx.beginPath();
        ctx.moveTo(qrX - qrPad + qrBoxR, qrY - qrPad);
        ctx.lineTo(qrX + qrSize + qrPad - qrBoxR, qrY - qrPad);
        ctx.quadraticCurveTo(qrX + qrSize + qrPad, qrY - qrPad, qrX + qrSize + qrPad, qrY - qrPad + qrBoxR);
        ctx.lineTo(qrX + qrSize + qrPad, qrY + qrSize + qrPad - qrBoxR);
        ctx.quadraticCurveTo(qrX + qrSize + qrPad, qrY + qrSize + qrPad, qrX + qrSize + qrPad - qrBoxR, qrY + qrSize + qrPad);
        ctx.lineTo(qrX - qrPad + qrBoxR, qrY + qrSize + qrPad);
        ctx.quadraticCurveTo(qrX - qrPad, qrY + qrSize + qrPad, qrX - qrPad, qrY + qrSize + qrPad - qrBoxR);
        ctx.lineTo(qrX - qrPad, qrY - qrPad + qrBoxR);
        ctx.quadraticCurveTo(qrX - qrPad, qrY - qrPad, qrX - qrPad + qrBoxR, qrY - qrPad);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
        ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);
      }

      // åº•éƒ¨æ–‡å­—
      const textX = qrX + qrSize + 20;
      ctx.textAlign = "left";
      ctx.fillStyle = "#0F172A";
      ctx.font = "800 17px -apple-system, 'PingFang SC', sans-serif";
      ctx.fillText("æ‰«ç æµ‹ä½ å®¶æ¯›å­©å­", textX, qrY + 35);
      ctx.fillStyle = "#64748B";
      ctx.font = "13px -apple-system, 'PingFang SC', sans-serif";
      ctx.fillText("1åˆ†é’Ÿå‡ºç»“æœ Â· 16ç§æ€§æ ¼", textX, qrY + 58);

      ctx.restore();

      const dataUrl = canvas.toDataURL("image/png");

      const img = document.getElementById("posterImg");
      const preview = document.getElementById("posterPreview");
      const saveTip = document.getElementById("saveTip");
      img.src = dataUrl;
      img.style.display = "block";
      if(preview) preview.classList.add("is-show");
      if(saveTip) saveTip.style.display = "flex";

      // è‡ªåŠ¨æ»šåŠ¨åˆ°å›¾ç‰‡ä½ç½®
      if(opts.scrollToPreview){
        (preview || img).scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // PC å°è¯•ä¸‹è½½
      if(opts.autoDownload && !/MicroMessenger/i.test(navigator.userAgent)){
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = "æ¯›å­©å­MBTI-" + (finalType || "RESULT") + ".png";
        a.click();
      }

      if(opts.showSuccessToast){
        toast(opts.refreshOnly ? "å¤´åƒå·²æ›´æ–°ï¼Œæµ·æŠ¥å·²åˆ·æ–°" : "å·²ç”Ÿæˆå›¾ç‰‡ï¼Œé•¿æŒ‰å¯ä¿å­˜");
      }

      // äºŒæ¬¡è½¬åŒ–ï¼šç”Ÿæˆæµ·æŠ¥åå¼¹å‡ºä¼å¾®å¼¹çª—ï¼ˆä»…é™ä¸€æ¬¡ï¼‰
      if (!hasShownWecomModal) {
        setTimeout(function(){
          showWecomModal();
          hasShownWecomModal = true;
        }, 1500);
      }
    }catch(e){
      console.error(e);
      toast("ç”Ÿæˆå¤±è´¥ï¼š" + (e.message || e));
    }
  }

  function setBar(p){


    const w = Math.max(0, Math.min(1, p)) * 100;
    const bar = document.getElementById("bar");
    if(bar) bar.style.width = w.toFixed(0) + "%";
  }

  function toast(msg){
    const el = document.getElementById("toast");
    el.innerText = msg;
    el.style.display = "block";
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> el.style.display="none", 2000);
  }

</script>
</body>
</html>
