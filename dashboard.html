<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ğŸ¾ æ¯›å­©å­MBTI - æ•°æ®çœ‹æ¿</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f0eb; color: #2D2A26; min-height: 100vh; }

  .header { background: linear-gradient(135deg, #FF6B81, #FF8C5A); color: #fff; padding: 24px 20px; text-align: center; }
  .header h1 { font-size: 20px; font-weight: 800; }
  .header .sub { font-size: 13px; opacity: 0.85; margin-top: 6px; }

  .container { max-width: 600px; margin: 0 auto; padding: 16px; }

  /* æ§åˆ¶æ  */
  .controls { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  .controls button { flex: 1; min-width: 80px; padding: 10px 12px; border: 2px solid #FF6B81; background: #fff; color: #FF6B81; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
  .controls button.active { background: #FF6B81; color: #fff; }

  /* æ•°æ®å¡ç‰‡ */
  .card { background: #fff; border-radius: 14px; padding: 18px; margin-bottom: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .card-title { font-size: 15px; font-weight: 800; color: #2D2A26; margin-bottom: 14px; }

  /* æ¼æ–— */
  .funnel-step { display: flex; align-items: center; margin-bottom: 10px; }
  .funnel-label { width: 110px; font-size: 13px; color: #5D4E3C; font-weight: 600; flex-shrink: 0; }
  .funnel-bar-wrap { flex: 1; height: 28px; background: #f0ebe6; border-radius: 8px; overflow: hidden; position: relative; }
  .funnel-bar { height: 100%; border-radius: 8px; transition: width 0.6s ease; min-width: 2px; }
  .funnel-num { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 12px; font-weight: 800; color: #5D4E3C; }
  .funnel-rate { width: 55px; text-align: right; font-size: 12px; color: #FF6B81; font-weight: 700; flex-shrink: 0; margin-left: 6px; }

  /* æ’è¡Œ */
  .rank-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0ebe6; }
  .rank-row:last-child { border-bottom: none; }
  .rank-type { font-weight: 800; font-size: 15px; }
  .rank-count { font-size: 13px; color: #8C7E73; }
  .rank-pct { font-size: 13px; color: #FF6B81; font-weight: 700; }

  /* ç»Ÿè®¡æ•°å­— */
  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .stat-item { text-align: center; padding: 12px 8px; background: #faf6f2; border-radius: 10px; }
  .stat-num { font-size: 26px; font-weight: 800; color: #FF6B81; }
  .stat-label { font-size: 12px; color: #8C7E73; margin-top: 4px; }

  /* åŠ è½½ */
  .loading { text-align: center; padding: 40px 20px; color: #8C7E73; }
  .loading .spinner { display: inline-block; width: 32px; height: 32px; border: 3px solid #f0ebe6; border-top-color: #FF6B81; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .error { text-align: center; padding: 30px; color: #C94040; font-size: 14px; }
  .refresh-btn { display: block; width: 100%; padding: 14px; background: linear-gradient(135deg, #FF6B81, #FF8C5A); color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; }
  .time-info { text-align: center; font-size: 12px; color: #b0a89e; margin-bottom: 16px; }
</style>
<script src="https://static.cloudbase.net/cloudbase-js-sdk/2.17.3/cloudbase.full.js"></script>
</head>
<body>

<div class="header">
  <h1>ğŸ¾ æ¯›å­©å­MBTI æ•°æ®çœ‹æ¿</h1>
  <div class="sub">å®æ—¶æŸ¥çœ‹ç”¨æˆ·è¡Œä¸ºæ¼æ–—å’Œæµ‹è¯•åˆ†å¸ƒ</div>
</div>

<div class="container">
  <div class="time-info" id="timeInfo">åŠ è½½ä¸­...</div>

  <div class="controls">
    <button class="active" onclick="switchRange('today')">ä»Šæ—¥</button>
    <button onclick="switchRange('7d')">è¿‘7å¤©</button>
    <button onclick="switchRange('30d')">è¿‘30å¤©</button>
    <button onclick="switchRange('all')">å…¨éƒ¨</button>
  </div>

  <div class="controls" id="petFilter">
    <button class="active" onclick="switchPet('all')">å…¨éƒ¨</button>
    <button onclick="switchPet('dog')">ğŸ¶ ç‹—ç‹—</button>
    <button onclick="switchPet('cat')">ğŸ± çŒ«å’ª</button>
  </div>

  <div id="content">
    <div class="loading"><div class="spinner"></div><p style="margin-top:12px">æ­£åœ¨æŸ¥è¯¢æ•°æ®åº“...</p></div>
  </div>

  <button class="refresh-btn" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
</div>

<script>
  // ========== CloudBase åˆå§‹åŒ– ==========
  const app = cloudbase.init({ env: 'mengchong-dev-6g4qar062ad266bc' });
  let db = null;
  let currentRange = 'today';
  let currentPet = 'all';

  async function initDB() {
    try {
      const auth = app.auth({ persistence: 'local' });
      await auth.signInAnonymously();
      db = app.database();
      console.log('[Dashboard] CloudBase åˆå§‹åŒ–æˆåŠŸ');
    } catch(e) {
      console.error('[Dashboard] åˆå§‹åŒ–å¤±è´¥', e);
      document.getElementById('content').innerHTML = '<div class="error">CloudBase è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•<br><br>' + e.message + '</div>';
    }
  }

  // ========== æ—¶é—´èŒƒå›´ ==========
  function getStartTime(range) {
    const now = new Date();
    if (range === 'today') {
      return new Date(now.getFullYear(), now.getMonth(), now.getDate());
    } else if (range === '7d') {
      return new Date(now.getTime() - 7 * 24 * 3600 * 1000);
    } else if (range === '30d') {
      return new Date(now.getTime() - 30 * 24 * 3600 * 1000);
    }
    return new Date(0); // all
  }

  function switchRange(range) {
    currentRange = range;
    const btns = document.querySelectorAll('.controls:not(#petFilter) button');
    btns.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    loadData();
  }

  function switchPet(pet) {
    currentPet = pet;
    const btns = document.querySelectorAll('#petFilter button');
    btns.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    loadData();
  }

  // ========== åˆ†æ‰¹æŸ¥è¯¢ï¼ˆCloudBaseå•æ¬¡é™100æ¡ï¼‰==========
  async function fetchAllEvents(startTime) {
    const _ = db.command;
    let allDocs = [];
    let lastTs = startTime.getTime();
    const batchSize = 100;

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    const buildWhere = (ts) => {
      const cond = { ts: _.gte(ts) };
      if (currentPet === 'cat') {
        cond.pet = 'cat';
      } else if (currentPet === 'dog') {
        // å‘åå…¼å®¹ï¼šå†å²æ•°æ®æ²¡æœ‰ pet å­—æ®µï¼Œä¹Ÿç®—ç‹—ç‹—
        cond.pet = _.eq('dog').or(_.exists(false));
      }
      return cond;
    };

    while (true) {
      const res = await db.collection('events')
        .where(buildWhere(lastTs))
        .orderBy('ts', 'asc')
        .limit(batchSize)
        .get();

      if (!res.data || res.data.length === 0) break;
      allDocs = allDocs.concat(res.data);

      if (res.data.length < batchSize) break;
      // ä¸‹ä¸€æ‰¹ä»æœ€åä¸€æ¡çš„ts+1å¼€å§‹ï¼Œé¿å…é‡å¤
      lastTs = res.data[res.data.length - 1].ts + 1;
    }

    return allDocs;
  }

  // ========== æ ¸å¿ƒï¼šåŠ è½½å¹¶æ¸²æŸ“æ•°æ® ==========
  async function loadData() {
    if (!db) {
      document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:12px">æ­£åœ¨è¿æ¥æ•°æ®åº“...</p></div>';
      await initDB();
      if (!db) return;
    }

    document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:12px">æ­£åœ¨æŸ¥è¯¢æ•°æ®åº“...</p></div>';

    try {
      const startTime = getStartTime(currentRange);
      const docs = await fetchAllEvents(startTime);

      document.getElementById('timeInfo').innerText = 'æ•°æ®é‡ï¼š' + docs.length + ' æ¡ Â· æ›´æ–°äº ' + new Date().toLocaleTimeString('zh-CN') + ' Â· æ¯30ç§’è‡ªåŠ¨åˆ·æ–°';

      if (docs.length === 0) {
        document.getElementById('content').innerHTML = '<div class="card"><div class="card-title">æš‚æ— æ•°æ®</div><p style="color:#8C7E73;font-size:13px;">è¯¥æ—¶é—´èŒƒå›´å†…è¿˜æ²¡æœ‰ç”¨æˆ·è®¿é—®è®°å½•ï¼Œè¯•è¯•åˆ‡æ¢åˆ°"å…¨éƒ¨"çœ‹çœ‹ã€‚</p></div>';
        return;
      }

      // ========== ç»Ÿè®¡æ±‡æ€» ==========
      const funnel = { page_view:0, test_start:0, test_complete:0, unlock_modal_shown:0, content_unlocked:0, poster_generated:0, wecom_button_clicked:0 };
      const typeCount = {};
      const questionDrop = {};
      const uniqueUsers = new Set();

      docs.forEach(d => {
        if (d.c === 'funnel' && funnel.hasOwnProperty(d.a)) {
          funnel[d.a]++;
        }
        // ç»Ÿè®¡ç±»å‹åˆ†å¸ƒ
        if (d.a === 'test_complete' && d.l) {
          typeCount[d.l] = (typeCount[d.l] || 0) + 1;
        }
        // ç»Ÿè®¡åˆ°è¾¾æ¯é“é¢˜çš„äººæ•°
        if (d.a === 'question_reached' && d.l) {
          questionDrop[d.l] = (questionDrop[d.l] || 0) + 1;
        }
        // ç”¨ _openid ç»Ÿè®¡ç‹¬ç«‹ç”¨æˆ·
        if (d._openid) uniqueUsers.add(d._openid);
      });

      // ========== æ¸²æŸ“ ==========
      let html = '';

      // 1. æ ¸å¿ƒæ•°æ®æ¦‚è§ˆ
      const uvCount = uniqueUsers.size || funnel.page_view;
      const completeRate = funnel.page_view > 0 ? Math.round(funnel.test_complete / funnel.page_view * 100) : 0;
      const unlockRate = funnel.unlock_modal_shown > 0 ? Math.round(funnel.content_unlocked / funnel.unlock_modal_shown * 100) : 0;
      html += `<div class="card">
        <div class="card-title">ğŸ“Š æ ¸å¿ƒæ•°æ®</div>
        <div class="stat-grid">
          <div class="stat-item"><div class="stat-num">${uvCount}</div><div class="stat-label">ç‹¬ç«‹è®¿å®¢</div></div>
          <div class="stat-item"><div class="stat-num">${funnel.test_complete}</div><div class="stat-label">å®Œæˆæµ‹è¯•</div></div>
          <div class="stat-item"><div class="stat-num">${completeRate}%</div><div class="stat-label">å®Œæˆç‡</div></div>
          <div class="stat-item"><div class="stat-num">${funnel.content_unlocked}</div><div class="stat-label">è§£é”æŠ¥å‘Š</div></div>
          <div class="stat-item"><div class="stat-num">${unlockRate}%</div><div class="stat-label">è§£é”ç‡</div></div>
          <div class="stat-item"><div class="stat-num">${funnel.wecom_button_clicked}</div><div class="stat-label">ç‚¹å‡»é¢†å–</div></div>
        </div>
      </div>`;

      // 2. è½¬åŒ–æ¼æ–—
      const funnelSteps = [
        { key:'page_view', label:'æ‰“å¼€é¡µé¢', color:'#FF6B81' },
        { key:'test_start', label:'å¼€å§‹æµ‹è¯•', color:'#FF8C5A' },
        { key:'test_complete', label:'å®Œæˆæµ‹è¯•', color:'#FFB627' },
        { key:'unlock_modal_shown', label:'è§£é”å¼¹çª—', color:'#7ED9A6' },
        { key:'content_unlocked', label:'æˆåŠŸè§£é”', color:'#5CB8FF' },
        { key:'poster_generated', label:'ç”Ÿæˆæµ·æŠ¥', color:'#C4A6FF' },
        { key:'wecom_button_clicked', label:'ç‚¹å‡»é¢†å–', color:'#B088F9' },
      ];
      const maxVal = Math.max(...Object.values(funnel), 1);

      html += '<div class="card"><div class="card-title">ğŸ”½ è½¬åŒ–æ¼æ–—</div>';
      funnelSteps.forEach((step, i) => {
        const count = funnel[step.key];
        const pct = maxVal > 0 ? Math.round(count / maxVal * 100) : 0;
        const prevCount = i > 0 ? funnel[funnelSteps[i-1].key] : count;
        const stepRate = prevCount > 0 ? Math.round(count / prevCount * 100) : 0;
        const rateText = i === 0 ? 'â€”' : stepRate + '%';

        html += `<div class="funnel-step">
          <div class="funnel-label">${step.label}</div>
          <div class="funnel-bar-wrap">
            <div class="funnel-bar" style="width:${pct}%;background:${step.color}"></div>
            <div class="funnel-num">${count}</div>
          </div>
          <div class="funnel-rate">${rateText}</div>
        </div>`;
      });
      html += '</div>';

      // 3. ç±»å‹åˆ†å¸ƒæ’è¡Œ
      const typeArr = Object.entries(typeCount).sort((a,b) => b[1] - a[1]);
      if (typeArr.length > 0) {
        const totalComplete = typeArr.reduce((s,t) => s + t[1], 0);
        const typeColors = {
          ENFP:'#FF8C42', ENFJ:'#FF6B8A', ENTP:'#5CB8FF', ENTJ:'#C94040',
          ESFP:'#FFB627', ESFJ:'#FF7EB3', ESTP:'#FF6542', ESTJ:'#4A7C59',
          INFP:'#B088F9', INFJ:'#6C8EBF', INTP:'#5B9A8B', INTJ:'#4A5568',
          ISFP:'#E88DB4', ISFJ:'#F4A460', ISTP:'#708090', ISTJ:'#8B7355',
        };
        html += '<div class="card"><div class="card-title">ğŸ† ç±»å‹åˆ†å¸ƒæ’è¡Œ</div>';
        typeArr.forEach(([type, count]) => {
          const pct = Math.round(count / totalComplete * 100);
          const color = typeColors[type] || '#FF6B81';
          html += `<div class="rank-row">
            <div class="rank-type" style="color:${color}">${type}</div>
            <div class="rank-count">${count} äºº</div>
            <div class="rank-pct">${pct}%</div>
          </div>`;
        });
        html += '</div>';
      }

      // 4. é¢˜ç›®æµå¤±åˆ†æ
      const qKeys = Object.keys(questionDrop).sort((a,b) => {
        const na = parseInt(a.replace('q','')), nb = parseInt(b.replace('q',''));
        return na - nb;
      });
      if (qKeys.length > 1) {
        html += '<div class="card"><div class="card-title">ğŸ“‰ ç­”é¢˜æµå¤±åˆ†æ</div>';
        html += '<div style="font-size:12px;color:#8C7E73;margin-bottom:10px;">æ¯é“é¢˜åˆ°è¾¾äººæ•°ï¼Œä¸‹é™è¯´æ˜ç”¨æˆ·æµå¤±</div>';
        qKeys.forEach((q, i) => {
          const count = questionDrop[q];
          const maxQ = questionDrop[qKeys[0]] || 1;
          const pct = Math.round(count / maxQ * 100);
          const prevCount = i > 0 ? questionDrop[qKeys[i-1]] : count;
          const dropRate = prevCount > count ? ' (-' + Math.round((1 - count/prevCount) * 100) + '%)' : '';
          const barColor = pct > 70 ? '#5CB8FF' : pct > 40 ? '#FFB627' : '#FF6B81';
          html += `<div class="funnel-step">
            <div class="funnel-label" style="width:50px;">ç¬¬${q.replace('q','')}é¢˜</div>
            <div class="funnel-bar-wrap">
              <div class="funnel-bar" style="width:${pct}%;background:${barColor}"></div>
              <div class="funnel-num">${count}${dropRate}</div>
            </div>
            <div class="funnel-rate" style="width:40px;"></div>
          </div>`;
        });
        html += '</div>';
      }

      document.getElementById('content').innerHTML = html;

    } catch(e) {
      console.error('[Dashboard] æŸ¥è¯¢å¤±è´¥', e);
      document.getElementById('content').innerHTML = '<div class="error">æŸ¥è¯¢å¤±è´¥: ' + e.message + '<br><br>è¯·æ£€æŸ¥æ•°æ®åº“æƒé™è®¾ç½®</div>';
    }
  }

  // ========== å¯†ç ä¿æŠ¤ï¼ˆSHA-256 å“ˆå¸Œï¼Œä¸æš´éœ²æ˜æ–‡ï¼‰ ==========
  const DASH_PWD_HASH = 'f24ae8ffbf220bd1eafd381b0a4875756f2333a537ceff6b4d1e73998f6514a8';

  async function sha256(text) {
    const data = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
  }

  async function checkAccess() {
    const saved = sessionStorage.getItem('dash_ok');
    if (saved === '1') return true;
    const pwd = prompt('è¯·è¾“å…¥çœ‹æ¿å¯†ç ï¼š');
    if (!pwd) {
      document.body.innerHTML = '<div style="text-align:center;padding:80px 20px;color:#8C7E73;font-size:16px;">å¯†ç é”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
      return false;
    }
    const hash = await sha256(pwd);
    if (hash === DASH_PWD_HASH) {
      sessionStorage.setItem('dash_ok', '1');
      return true;
    }
    document.body.innerHTML = '<div style="text-align:center;padding:80px 20px;color:#8C7E73;font-size:16px;">å¯†ç é”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
    return false;
  }

  // ========== è‡ªåŠ¨åˆ·æ–° ==========
  let autoRefreshTimer = null;
  function startAutoRefresh() {
    stopAutoRefresh();
    autoRefreshTimer = setInterval(() => {
      console.log('[Dashboard] è‡ªåŠ¨åˆ·æ–°');
      loadData();
    }, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
  }
  function stopAutoRefresh() {
    if (autoRefreshTimer) { clearInterval(autoRefreshTimer); autoRefreshTimer = null; }
  }

  // ========== å¯åŠ¨ ==========
  (async function() {
    if (!(await checkAccess())) return;
    await initDB();
    await loadData();
    startAutoRefresh();
  })();
</script>

</body>
</html>
